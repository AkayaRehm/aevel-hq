{% extends "base_aevel.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Settings</h1>
  <p class="subtitle">Preferences</p>
</div>

<section class="section">
  <h2 class="section-title">Dashboard</h2>
  <div class="card">
    <div class="prefs-grid">
      <label class="pref-row">
        <input type="checkbox" id="pref-dashboard_kpis" class="pref-checkbox">
        <span>Summary numbers</span>
      </label>
      <label class="pref-row">
        <input type="checkbox" id="pref-dashboard_widgets" class="pref-checkbox">
        <span>Schedule and activity</span>
      </label>
      <label class="pref-row">
        <input type="checkbox" id="pref-compact" class="pref-checkbox">
        <span>Compact layout</span>
      </label>
    </div>
    <button type="button" class="btn btn-primary" id="prefs-save" style="margin-top: 1rem;">Save preferences</button>
    <span id="prefs-feedback" class="form-error" style="margin-top: 0.5rem; display: block;"></span>
  </div>
</section>

<section class="section">
  <h2 class="section-title">Account</h2>
  <div class="card">
    <div class="card-title">Email</div>
    <p style="margin: 0; font-size: 0.9375rem; color: var(--text-secondary);">{{ session.get('user_email', '') }}</p>
  </div>
</section>

<section class="section">
  <h2 class="section-title">Session</h2>
  <div class="card">
    <form method="POST" action="{{ url_for('logout') }}">
      <button type="submit" class="btn btn-ghost">Sign out</button>
    </form>
  </div>
</section>

<section class="section">
  <h2 class="section-title">About</h2>
  <div class="card">
    <div class="card-title">Aevel</div>
    <p style="margin: 0; font-size: 0.9375rem; color: var(--text-secondary);">Analytics and automation. Pipeline, reports, tasks, calendar.</p>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script>
(function() {
  var prefs = {};
  function load() {
    fetch('/api/preferences').then(function(r) { return r.json(); }).then(function(d) {
      prefs = d;
      document.getElementById('pref-dashboard_kpis').checked = d.dashboard_kpis !== false;
      document.getElementById('pref-dashboard_widgets').checked = d.dashboard_widgets !== false;
      document.getElementById('pref-compact').checked = !!d.compact;
      applyCompact(d.compact);
    });
  }
  function applyCompact(on) {
    document.body.classList.toggle('compact', !!on);
  }
  document.getElementById('pref-compact').addEventListener('change', function() { applyCompact(this.checked); });
  document.getElementById('prefs-save').addEventListener('click', function() {
    var payload = {
      dashboard_kpis: document.getElementById('pref-dashboard_kpis').checked,
      dashboard_chart: true,
      dashboard_recent: true,
      dashboard_widgets: document.getElementById('pref-dashboard_widgets').checked,
      compact: document.getElementById('pref-compact').checked
    };
    fetch('/api/preferences', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        prefs = d;
        var fb = document.getElementById('prefs-feedback');
        fb.textContent = 'Preferences saved.';
        fb.style.color = 'var(--success)';
        if (typeof Aevel !== 'undefined') Aevel.toast('Preferences saved', 'success');
        setTimeout(function() { fb.textContent = ''; }, 3000);
      })
      .catch(function() {
        var fb = document.getElementById('prefs-feedback');
        if (fb) { fb.textContent = 'Failed to save.'; fb.style.color = 'var(--danger)'; }
        if (typeof Aevel !== 'undefined' && Aevel.toast) Aevel.toast('Failed to save preferences', 'error');
      });
  });
  load();
})();
</script>
{% endblock %}
