{% extends "base_aevel.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Dashboard</h1>
</div>

<div class="dashboard-surface">
  <div class="dashboard-summary" id="dashboard-summary">
    <div class="dashboard-summary-item">
      <div class="card-value" id="kpi-tasks"><span class="skeleton" style="display:inline-block;width:2rem;height:1.5rem;vertical-align:middle;"></span></div>
      <div class="card-meta" id="kpi-tasks-meta">Tasks</div>
    </div>
    <div class="dashboard-summary-item">
      <div class="card-value" id="kpi-done"><span class="skeleton" style="display:inline-block;width:2rem;height:1.5rem;vertical-align:middle;"></span></div>
      <div class="card-meta">Done</div>
    </div>
    <div class="dashboard-summary-item">
      <div class="card-value" id="kpi-notes"><span class="skeleton" style="display:inline-block;width:2rem;height:1.5rem;vertical-align:middle;"></span></div>
      <div class="card-meta">Reports</div>
    </div>
    <div class="dashboard-summary-item">
      <div class="card-value" id="kpi-events"><span class="skeleton" style="display:inline-block;width:2rem;height:1.5rem;vertical-align:middle;"></span></div>
      <div class="card-meta">Events</div>
    </div>
  </div>

  <div class="dashboard-activity" id="dashboard-activity">
    <div class="dashboard-block">
      <div class="dashboard-block-title">Schedule</div>
      <div class="cal-mini" id="cal-mini"></div>
      <ul class="widget-events-list" id="widget-events"></ul>
      <form class="form-inline" id="widget-task-form" style="margin-top: 1rem;">
        <input type="text" class="input" id="widget-task-input" placeholder="New task" aria-label="New task" style="flex:1;min-width:0;margin-bottom:0;">
        <button type="submit" class="btn btn-primary btn-small">Add</button>
      </form>
      <div id="widget-tasks-list" class="widget-tasks-list"></div>
    </div>
    <div class="dashboard-block">
      <div class="dashboard-block-title">Activity</div>
      <div class="table-wrap">
        <table class="table" id="recent-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Item</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recent-tbody">
            <tr><td colspan="3" class="cell-primary">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
(function() {
  function applyPrefs(prefs) {
    var summary = document.getElementById('dashboard-summary');
    var activity = document.getElementById('dashboard-activity');
    if (prefs.dashboard_kpis !== false && summary) summary.style.display = '';
    else if (summary) summary.style.display = 'none';
    if (prefs.dashboard_widgets !== false && activity) activity.style.display = '';
    else if (activity) activity.style.display = 'none';
  }
  fetch('/api/preferences').then(function(r) { return r.json(); }).then(applyPrefs).catch(function() {});

  function loadStats() {
    fetch('/api/dashboard/stats')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var total = d.tasks_total || 0;
        var done = d.tasks_done || 0;
        document.getElementById('kpi-tasks').textContent = total - done;
        document.getElementById('kpi-tasks-meta').textContent = total + ' total';
        document.getElementById('kpi-done').textContent = done;
        document.getElementById('kpi-notes').textContent = d.notes_count || 0;
        document.getElementById('kpi-events').textContent = d.events_count || 0;
      })
      .catch(function() {
        document.getElementById('kpi-tasks').textContent = '—';
        document.getElementById('kpi-tasks-meta').textContent = '—';
        document.getElementById('kpi-done').textContent = '—';
        document.getElementById('kpi-notes').textContent = '—';
        document.getElementById('kpi-events').textContent = '—';
      });
  }

  function loadRecent() {
    Promise.all([
      fetch('/api/tasks').then(function(r) { return r.json(); }),
      fetch('/api/notes').then(function(r) { return r.json(); })
    ])
      .then(function(arr) {
        var tasks = (arr[0].tasks || []).map(function(t) { return { type: 'Task', desc: t.text, status: t.done ? 'Done' : 'Active', created_at: t.created_at || '' }; });
        var notes = (arr[1].notes || []).map(function(n) { return { type: 'Report', desc: n.title, status: '—', created_at: n.created_at || '' }; });
        var rows = tasks.concat(notes);
        rows.sort(function(a, b) {
          var da = a.created_at || '';
          var db = b.created_at || '';
          return db.localeCompare(da);
        });
        rows = rows.slice(0, 10);
        var tbody = document.getElementById('recent-tbody');
        if (!tbody) return;
        if (rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3"><div class="empty-state"><p class="empty-state__title">No activity</p><p><a href="/tasks">Tasks</a> · <a href="/reports">Reports</a></p></div></td></tr>';
        } else {
          tbody.innerHTML = rows.map(function(r) {
            return '<tr><td class="cell-primary">' + (r.type || '') + '</td><td>' + (r.desc || '').substring(0, 48) + '</td><td>' + (r.status || '') + '</td></tr>';
          }).join('');
        }
      })
      .catch(function() {
        var tbody = document.getElementById('recent-tbody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="3" class="cell-primary">Failed to load. <a href="#" onclick="location.reload();return false;">Retry</a></td></tr>';
      });
  }

  function loadWidgetEvents() {
    fetch('/api/events')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var now = new Date();
        var m = now.getMonth() + 1;
        var y = now.getFullYear();
        var prefix = y + '-' + (m < 10 ? '0' : '') + m;
        var events = (d.events || []).filter(function(e) { return e.date && e.date.startsWith(prefix); }).slice(0, 5);
        var el = document.getElementById('widget-events');
        if (!el) return;
        el.innerHTML = events.length ? events.map(function(e) { return '<li><span class="date">' + (e.date || '') + '</span><span>' + (e.title || '').replace(/</g, '&lt;') + '</span></li>'; }).join('') : '<li class="empty">No events. <a href="/calendar">Calendar</a></li>';
      })
      .catch(function() {
        var el = document.getElementById('widget-events');
        if (el) el.innerHTML = '<li class="empty">—</li>';
      });
  }

  function loadWidgetTasks() {
    fetch('/api/tasks')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var tasks = (d.tasks || []).slice(0, 6);
        var el = document.getElementById('widget-tasks-list');
        if (!el) return;
        el.innerHTML = tasks.length ? tasks.map(function(t) {
          return '<div class="task-row ' + (t.done ? 'done' : '') + '" data-id="' + (t.id || '') + '"><input type="checkbox" ' + (t.done ? 'checked' : '') + ' aria-label="Mark done"><span class="task-label">' + (t.text || '').replace(/</g, '&lt;') + '</span></div>';
        }).join('') : '<div class="empty"><a href="/tasks">Tasks</a></div>';
        el.querySelectorAll('input[type=checkbox]').forEach(function(cb) {
          cb.addEventListener('change', function() {
            var row = cb.closest('.task-row');
            var id = row && row.getAttribute('data-id');
            if (!id) return;
            var api = (typeof Aevel !== 'undefined' && Aevel.api) ? Aevel.api : function(method, path, body) {
              return fetch(path, { method: method, credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body || {}) }).then(function(r) { return r.json().then(function(d) { if (!r.ok) throw new Error(d.error || 'Request failed'); return d; }); });
            };
            api('PATCH', '/api/tasks/' + id, { done: cb.checked }).then(function() { loadWidgetTasks(); loadStats(); loadRecent(); }).catch(function() {});
          });
        });
      })
      .catch(function() {
        var el = document.getElementById('widget-tasks-list');
        if (el) el.innerHTML = '<div class="empty">—</div>';
      });
  }

  function buildCalMini() {
    var now = new Date();
    var y = now.getFullYear();
    var m = now.getMonth();
    var first = new Date(y, m, 1);
    var last = new Date(y, m + 1, 0);
    var startDay = first.getDay();
    var days = last.getDate();
    var w = ['S','M','T','W','T','F','S'];
    var html = w.map(function(d) { return '<div class="day head">' + d + '</div>'; }).join('');
    for (var i = 0; i < startDay; i++) html += '<div class="day"></div>';
    for (var d = 1; d <= days; d++) {
      var cls = 'day';
      if (d === now.getDate() && m === now.getMonth()) cls += ' today';
      html += '<div class="' + cls + '">' + d + '</div>';
    }
    var el = document.getElementById('cal-mini');
    if (el) el.innerHTML = html;
  }

  document.getElementById('widget-task-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var input = document.getElementById('widget-task-input');
    var text = (input && input.value || '').trim();
    if (!text) return;
    var api = (typeof Aevel !== 'undefined' && Aevel.api) ? Aevel.api : function(method, path, body) {
      return fetch(path, { method: method, credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body || {}) }).then(function(r) { return r.json().then(function(d) { if (!r.ok) throw new Error(d.error || 'Request failed'); return d; }); });
    };
    api('POST', '/api/tasks', { text: text }).then(function() {
      input.value = '';
      loadWidgetTasks();
      loadStats();
      loadRecent();
      if (typeof Aevel !== 'undefined' && Aevel.toast) Aevel.toast('Added', 'success');
    }).catch(function() {});
  });

  loadStats();
  loadRecent();
  loadWidgetEvents();
  loadWidgetTasks();
  buildCalMini();
})();
</script>
{% endblock %}
